name: Agent Run from Issue

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to run (required for manual run)"
        required: true
        type: string

concurrency:
  group: agent-run-${{ github.event.issue.number || github.event.inputs.issue_number || github.run_id }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  run-agent:
    if: ${{ github.event_name == 'workflow_dispatch' || contains(github.event.issue.labels.*.name, 'agent:run') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- Issue番号を必ず確定させて表示する（ここが一番重要） ---
      - name: Resolve issue number
        id: issue
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "issues" ]; then
            n="${{ github.event.issue.number }}"
          else
            n="${{ github.event.inputs.issue_number }}"
          fi

          if [ -z "$n" ]; then
            echo "ERROR: issue number is empty. For manual run, set workflow_dispatch input 'issue_number'." >&2
            exit 1
          fi

          echo "issue_number=$n" >> "$GITHUB_OUTPUT"
          echo "[agent] issue_number=$n"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Set up Node (for github-script)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Configure git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies (agent)
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Run agent tool
        id: agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.issue_number }}
          ISSUE_LABELS_JSON: ${{ toJson(github.event.issue.labels) }}
        run: |
          python tools/agent_run.py --issue "$ISSUE_NUMBER"

      - name: Run quality gate
        shell: pwsh
        run: |
          ./scripts/dev_run_checks.ps1 -SkipInstall

      # --- 変更があるときだけPRを作る / 変更なしは成功扱いでコメント ---
      - name: Create PR if changes exist
        id: pr
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.issue_number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = process.env.ISSUE_NUMBER;
            if (!issueNumber) {
              core.setFailed("ISSUE_NUMBER missing");
              return;
            }

            // git status --porcelain を確実に取る
            let statusOut = "";
            await exec.exec("git", ["status", "--porcelain"]); {
              listeners: {
                stdout: (data) => { statusOut += data.toString(); },
                stderr: (data) => { statusOut += data.toString(); },
              },
            });

            if (!statusOut.trim()) {
              core.setOutput("no_changes", "true");
              core.info("NO_CHANGES: nothing to commit; skipping PR creation.");
              return;
            }

            const ts = new Date().toISOString().replace(/[-:T]/g, "").slice(0, 12);
            const branch = `agent/issue-${issueNumber}-${ts}`;

            await exec("git", ["checkout", "-B", branch]);
            await exec("git", ["add", "."]);
            await exec("git", ["commit", "-m", `chore: agent for #${issueNumber}`]);
            await exec("git", ["push", "-u", "origin", branch]);

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: branch,
              base: "main",
              title: `Agent run for #${issueNumber}`,
              body: `Automated agent run for #${issueNumber}.`
            });

            core.setOutput("pr_url", pr.html_url);

      - name: Comment result on issue (label runs only)
        if: ${{ github.event.issue.number }}
        uses: actions/github-script@v7
        env:
          PR_URL: ${{ steps.pr.outputs.pr_url }}
          NO_CHANGES: ${{ steps.pr.outputs.no_changes }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.issue_number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = process.env.ISSUE_NUMBER;
            const prUrl = process.env.PR_URL || "";
            const noChanges = (process.env.NO_CHANGES || "") === "true";

            let body = "";
            if (noChanges) {
              body = "Agent run finished: **no code changes detected** (no PR created).";
            } else if (prUrl) {
              body = `Agent run created PR: ${prUrl}`;
            } else {
              body = "Agent run finished, but PR URL was not produced. Please check workflow logs.";
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number(issueNumber),
              body
            });

      - name: Remove agent label (label runs only)
        if: ${{ github.event.issue.number }}
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.issue_number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = Number(process.env.ISSUE_NUMBER);
            const labels = (context.payload.issue.labels || []).map(l => l.name);
            if (labels.includes("agent:run")) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: "agent:run"
              }).catch(() => {});
            }

      - name: Comment failure on issue (label runs only)
        if: ${{ failure() && github.event.issue.number }}
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.issue_number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = Number(process.env.ISSUE_NUMBER);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `Agent run failed. Please check workflow logs.`
            });
