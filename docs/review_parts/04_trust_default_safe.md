# 信頼設計レビュー（プライバシー＋デフォルト安全編）

## サマリ

1. **Fail-Closed（Stop設計）は秀逸** — Gemini API障害時・低確信度時に一貫してGUIDANCE（判定停止）へ倒す設計は、信頼設計のお手本。feature flagのデフォルトOFFも安全側。
2. **アップロードPDFの永続保存が最大のプライバシーリスク** — `data/uploads/` と `data/results/` にPDF・抽出結果が保持期限なく蓄積。請求書・見積書は機密性の高い財務データであり、削除ポリシーの不在は重大。
3. **LLMへのデータ送信に関するユーザー通知・同意が皆無** — Gemini API/Vertex AI Searchへ請求書の全明細・金額・取引先名が送信されるが、UIにその旨の説明がない。ユーザーは自分のデータがどこに行くか把握できない。

---

## 指摘事項

### C-01: アップロードPDFの無期限保存（Critical）

| 項目 | 内容 |
|------|------|
| **深刻度** | Critical |
| **対象ファイル** | `core/pipeline.py:60-75` (`_persist_pdf_to_uploads`)、`ui/app.py:214-224` (`_save_uploaded_pdf`) |
| **問題** | アップロードされたPDFが `data/uploads/` に恒久的にコピー・保存される。削除ポリシー、保持期間、自動削除メカニズムがいずれも存在しない。請求書・見積書には取引先名、金額、担当者名などの機密情報が含まれる。 |
| **チェックリスト該当項目** | プライバシー設計 §4「データ保存」— 保持期間の定義、自動削除メカニズム。デフォルト安全 P4「最小データ収集」 |
| **修正提案** | (1) API経路（`/classify_pdf`）の一時ファイルは処理後削除済み（`finally`ブロック）だが、UI経路とpipeline経路では永続保存される。UI/pipeline経路にも処理後削除を実装する。(2) 永続保存が必要な場合は保持期間（例: 24時間）と自動削除バッチを導入する。(3) 保存時の暗号化を検討する。 |

### C-02: 抽出結果JSONの無期限保存（Critical）

| 項目 | 内容 |
|------|------|
| **深刻度** | Critical |
| **対象ファイル** | `core/pipeline.py:78-109` (`run_pdf_pipeline`)、`core/pipeline.py:37-41` (`save_json`) |
| **問題** | `data/results/` にPDF抽出結果（`_extract.json`）と最終判定結果（`_final.json`）が恒久保存される。これらにはPDFから抽出されたテキスト全文、明細金額、取引先名が平文で含まれる。保持期限・アクセス制御・暗号化なし。 |
| **チェックリスト該当項目** | プライバシー設計 §4「データ保存」全項目。デフォルト安全 P3「デフォルト暗号化」 |
| **修正提案** | (1) 保持期間を定義し、期限切れデータを自動削除する。(2) 保存時に暗号化を適用する。(3) ファイルパーミッションを制限する。 |

### C-03: LLMへのデータ送信に関する情報開示の欠如（Critical）

| 項目 | 内容 |
|------|------|
| **深刻度** | Critical |
| **対象ファイル** | `api/gemini_classifier.py:260-268`、`api/gemini_splitter.py:130-138`、`core/pdf_extract.py:202-209`、`api/useful_life_estimator.py:171-179` |
| **問題** | 以下のデータがGoogle Gemini APIに送信されるが、ユーザーへの通知・同意取得が一切ない: (1) 明細の品名・金額・数量 (2) 取引先名・書類タイトル (3) PDFページ画像（Gemini Vision） (4) 資産名（耐用年数推定）。ユーザーは自分の財務データが外部サービスに送信されることを知り得ない。 |
| **チェックリスト該当項目** | プライバシー設計 §2「同意取得」、§3「データ使用と共有」、§6「透明性」。デフォルト安全 P9「プライバシー設定の可視化」 |
| **修正提案** | (1) UIに「判定にはGoogle Gemini APIを使用します。アップロードされた書類のデータがGoogleのサーバーに送信されます」という明示的な説明を追加。(2) LLM使用のオプトイン同意を取得。(3) Gemini使用時とルールベース判定時で送信データ範囲を明示。 |

### M-01: Embedding StoreのJSON平文保存（Major）

| 項目 | 内容 |
|------|------|
| **深刻度** | Major |
| **対象ファイル** | `api/embedding_store.py:203-213` (`save`)、デフォルトパス `data/embeddings.json` |
| **問題** | 資産台帳データ（資産名・金額等のメタデータ）がEmbedding付きでJSON平文保存される。暗号化なし、アクセス制御なし、保持期間未定義。 |
| **チェックリスト該当項目** | プライバシー設計 §4「暗号化（保存時）」「アクセス権限は必要最小限か」。デフォルト安全 P3「デフォルト暗号化」 |
| **修正提案** | (1) 保存時暗号化の導入。(2) ファイルパーミッションの制限（600）。(3) 保持期間の定義。 |

### M-02: APIエンドポイントの認証・認可なし（Major）

| 項目 | 内容 |
|------|------|
| **深刻度** | Major |
| **対象ファイル** | `api/main.py:111` (`app = FastAPI(...)`)、全エンドポイント |
| **問題** | `/classify`、`/classify_pdf`、`/classify_batch` の全エンドポイントに認証・認可メカニズムがない。誰でもアクセス可能。Cloud Runのデプロイ想定でもIAM認証はコード側で制御されていない。 |
| **チェックリスト該当項目** | デフォルト安全 P1「デフォルトでアクセス拒否」、P2「最小権限」 |
| **修正提案** | (1) API認証（APIキー、OAuth2、Cloud Run IAM）の導入。(2) レート制限の実装（特にバッチエンドポイント）。(3) Cloud Run側のIAM設定に依存する場合でも、コード側に認証チェックを追加する多層防御。 |

### M-03: バッチアップロード時のファイル数・サイズ制限なし（Major）

| 項目 | 内容 |
|------|------|
| **深刻度** | Major |
| **対象ファイル** | `api/main.py:746-842` (`/classify_batch`)、`ui/batch_upload.py:60-66` |
| **問題** | バッチエンドポイントにファイル数の上限制限がない。UIは複数ファイル選択が可能だが上限なし。大量ファイルの同時アップロードにより: (1) メモリ枯渇リスク (2) 一時ファイルのディスク枯渇 (3) Gemini API利用料の無制限増大。個別の30秒タイムアウトはあるが全体制限がない。 |
| **チェックリスト該当項目** | デフォルト安全 P7「安全な初期設定」 |
| **修正提案** | (1) バッチ上限を設定（例: 一度に最大20ファイル）。(2) ファイルサイズの個別上限を設定（例: 1ファイル50MB以下）。(3) 全体のタイムアウトを設定。 |

### M-04: エラーメッセージでの内部情報漏洩リスク（Major）

| 項目 | 内容 |
|------|------|
| **深刻度** | Major |
| **対象ファイル** | `api/main.py:501` (`ValueError`)、`api/main.py:829-835` (バッチエラー) |
| **問題** | ValueError発生時に `f"Invalid input: {str(e)}"` で例外メッセージがそのままレスポンスに含まれる。バッチ処理では `f"処理中にエラーが発生: {str(e)}"` が返される。例外メッセージにファイルパス、内部構造、ライブラリ情報が含まれる場合がある。 |
| **チェックリスト該当項目** | デフォルト安全 P6「安全側への失敗」 |
| **修正提案** | (1) ユーザー向けエラーメッセージは定型文に限定し、詳細はサーバーログのみに記録。(2) 例外メッセージを直接レスポンスに含めない。 |

### M-05: batch_upload.pyのデフォルトAPI URLがハードコード（Major）

| 項目 | 内容 |
|------|------|
| **深刻度** | Major |
| **対象ファイル** | `ui/batch_upload.py:291` |
| **問題** | `DEFAULT_API_URL = "https://fixed-asset-agentic-api-986547623556.asia-northeast1.run.app"` — 本番のCloud RunサービスURLがソースコードにハードコードされている。GCPプロジェクト番号（986547623556）を含む内部情報が公開されている。 |
| **チェックリスト該当項目** | デフォルト安全 P7「安全な初期設定」 |
| **修正提案** | (1) URLは環境変数のみから取得し、デフォルト値はlocalhostにする。(2) GCPプロジェクト番号を含むURLをソースから除去。 |

### m-01: ユーザーデータ削除機能の不在（Minor）

| 項目 | 内容 |
|------|------|
| **深刻度** | Minor |
| **対象ファイル** | `ui/app.py` 全体 |
| **問題** | ユーザーがアップロードしたデータ（PDF、判定結果）を自ら削除する機能がない。「判定結果のダウンロード」はあるが、サーバー上のデータ削除は不可。 |
| **チェックリスト該当項目** | プライバシー設計 §5「削除権」、§7「オフボーディング」。デフォルト安全 P10「容易な退会」 |
| **修正提案** | (1) UIに「アップロードデータを削除する」ボタンを追加。(2) APIに `/delete_upload/{id}` エンドポイントを追加。 |

### m-02: PDF画像送信時のデータ最小化が不十分（Minor）

| 項目 | 内容 |
|------|------|
| **深刻度** | Minor |
| **対象ファイル** | `core/pdf_extract.py:165` (`_try_gemini_vision`)、`api/gemini_splitter.py:130-138` |
| **問題** | Gemini Visionへのページ送信は5ページに制限されている（一定のデータ最小化）が、ページ全体の画像（ヘッダー、フッター、会社情報含む）が送信される。明細部分のみのクロップは行われていない。 |
| **チェックリスト該当項目** | プライバシー設計 §1「本当に必要なデータだけを収集しているか」。デフォルト安全 P4「最小データ収集」 |
| **修正提案** | 現時点では精度とのトレードオフがあるため、注記として認識しておく。将来的には明細部分のみの送信を検討。 |

---

## プライバシー設計チェックリスト照合結果

| # | カテゴリ | 項目 | 判定 | 備考 |
|---|---------|------|------|------|
| 1-1 | データ収集 | 収集目的の明文化 | **非準拠** | UIに収集目的の説明なし |
| 1-2 | データ収集 | Data Minimization | **一部準拠** | Gemini Vision 5ページ制限はあるが、全明細送信 |
| 1-3 | データ収集 | 「念のため」収集排除 | **準拠** | 判定に必要なデータのみ使用 |
| 1-4 | データ収集 | Just-in-time型収集 | **N/A** | バッチ処理ツールのため |
| 1-5 | データ収集 | 「なぜ必要か」の説明 | **非準拠** | 説明なし |
| 2-1 | 同意取得 | 明示的オプトイン | **非準拠** | LLM送信への同意取得なし |
| 2-2 | 同意取得 | 個別同意 | **非準拠** | 同意メカニズム自体がない |
| 2-3 | 同意取得 | ダークパターン不使用 | **準拠** | UIはシンプルで誘導なし |
| 3-1 | データ使用・共有 | 目的外使用なし | **準拠** | 判定目的のみで使用 |
| 3-2 | データ使用・共有 | サードパーティ共有の明示 | **非準拠** | Google Gemini APIへの送信を未告知 |
| 4-1 | データ保存 | 保持期間の定義 | **非準拠** | 保持期間の定義なし |
| 4-2 | データ保存 | 自動削除メカニズム | **非準拠** | 自動削除なし |
| 4-3 | データ保存 | 暗号化（保存時） | **非準拠** | 平文JSON保存 |
| 4-4 | データ保存 | 暗号化（転送時） | **準拠** | HTTPS（FastAPI + Cloud Run） |
| 4-5 | データ保存 | アクセス権限最小化 | **非準拠** | ファイルパーミッション未設定 |
| 5-1 | ユーザーの権利 | アクセス権 | **一部準拠** | 判定結果のダウンロード可 |
| 5-2 | ユーザーの権利 | 削除権 | **非準拠** | 削除機能なし |
| 5-3 | ユーザーの権利 | ポータビリティ | **一部準拠** | JSONダウンロード可 |
| 6-1 | 透明性 | プライバシーポリシー | **非準拠** | 存在しない |
| 6-2 | 透明性 | Privacy Dashboard | **非準拠** | 存在しない |
| 7-1 | オフボーディング | データ削除 | **非準拠** | 機能なし |
| 8-1 | インシデント対応 | 通知プロトコル | **非準拠** | 未策定 |
| 9-1 | デザイン確認 | Permission Fatigue防止 | **準拠** | feature flagでopt-in設計 |
| 10-1 | 法的コンプライアンス | 適用法令の特定 | **非準拠** | 未実施 |

**準拠率: 6/23 (26%) — 要改善**

---

## デフォルト安全の設計原則チェックリスト照合結果

| # | 原則 | 判定 | 備考 |
|---|------|------|------|
| P1 | デフォルトでアクセス拒否 | **一部準拠** | feature flagはデフォルトOFF（優秀）だが、APIエンドポイントに認証なし |
| P2 | 最小権限 | **非準拠** | API認証・認可なし、レート制限なし |
| P3 | デフォルトで暗号化 | **一部準拠** | 転送時（HTTPS）は○、保存時暗号化なし |
| P4 | 最小データ収集 | **一部準拠** | Gemini Vision 5ページ制限はあるが、全明細がLLMに送信される |
| P5 | デフォルトでオプトアウト | **準拠** | GEMINI_ENABLED等がデフォルトOFF。LLM機能は明示的に有効化が必要 |
| P6 | 安全側への失敗（Fail Secure） | **準拠（秀逸）** | Stop-first設計：不確実→GUIDANCE、API障害→GUIDANCE、低確信度→GUIDANCE。本ツール最大の強み |
| P7 | 安全な初期設定 | **一部準拠** | feature flagは優秀だが、API URLハードコード、バッチ上限なし |
| P8 | 自動更新 | **N/A** | ライブラリ管理は運用側の問題 |
| P9 | プライバシー設定の可視化 | **非準拠** | データ使用状況の可視化なし |
| P10 | 容易な退会 | **非準拠** | データ削除機能なし |

**準拠率: 2/9 (22%) — 要改善**（ただしP6 Fail Secureは業界水準を大きく超える優秀さ）

---

## 総合評価

### 強み（維持すべき設計）

| 評価 | 内容 |
|------|------|
| **Stop-first設計** | 不確実な場合にGUIDANCE（判定停止）へ倒す一貫した設計は信頼設計のお手本。`gemini_classifier.py` の `confidence < 0.7 → GUIDANCE` 強制、例外時のデフォルトGUIDANCEレスポンス、classifier.pyの混在キーワード→GUIDANCE はいずれも秀逸。 |
| **Feature Flagのデフォルト設計** | 全てのGCP連携機能（Gemini、Vertex AI Search、Document AI）がデフォルトOFF。明示的なオプトインが必要。これはデフォルト安全の原則P5に完全準拠。 |
| **API一時ファイルの適切な削除** | `/classify_pdf` のfinally句でのtemp file削除は適切。 |

### 最重要改善項目（優先順）

1. **C-01/C-02**: アップロードPDF・抽出結果の保持期間定義と自動削除の実装
2. **C-03**: LLMデータ送信に関するユーザー通知と同意取得の実装
3. **M-02**: API認証の導入
4. **M-05**: ハードコードされたAPI URLの除去
