# 信頼設計レビュー（セキュリティ編）

**レビュー日**: 2026-02-10
**レビュー対象**: api/, core/, policies/
**チェックリスト**: Security_Design_Checklist.md

---

## サマリ

APIエンドポイントに認証・認可が一切なく、全エンドポイントが無防備に公開されている（Critical）。アップロードされたPDFのファイル種別・サイズ検証がなく、policy_pathパラメータにパストラバーサル脆弱性がある（Critical）。プロンプトインジェクション対策が未実装で、悪意あるPDFやJSON入力によりLLM判定結果を操作される可能性がある（Critical）。Fail-to-GUIDANCE設計は適切だが、確信度90%超の免責表示ルールが未実装。

---

## 指摘事項

### C-01: APIエンドポイントに認証・認可がない

- **深刻度**: Critical
- **対象ファイル**: `api/main.py:111`（FastAppインスタンス生成）、全エンドポイント
- **問題の説明**: FastAPIアプリケーションに認証ミドルウェアが一切なく、`/classify`、`/classify_pdf`、`/classify_batch` の全エンドポイントが認証なしでアクセス可能。APIキー、JWT、OAuth等の認証機構が未実装。請求書・見積書という機密性の高い文書を処理するAPIが完全に無防備。
- **チェックリストの該当項目**: §3 認証（全項目非準拠）、§4 認可（全項目非準拠）
- **修正提案**:
  1. FastAPI の `Depends()` + APIキー認証を最低限実装（`X-API-Key` ヘッダー or Bearer token）
  2. Cloud Run で運用する場合は IAM ベースの認証を有効化
  3. 将来的にはOAuth2/OIDC統合を検討

### C-02: policy_path パラメータのパストラバーサル

- **深刻度**: Critical
- **対象ファイル**: `api/main.py:376-382`（/classify）、`api/main.py:509,633-638`（/classify_pdf）
- **問題の説明**: `ClassifyRequest.policy_path` および `/classify_pdf` のクエリパラメータ `policy_path` がユーザー入力をそのまま `load_policy()` に渡している。`core/policy.py:46-87` の `load_policy()` はパスの検証を行わずにファイルを読み込むため、攻撃者が `../../etc/passwd` 等の任意パスを指定してファイルシステム上の任意のJSONファイルを読み取れる。
- **チェックリストの該当項目**: §7 入力検証（すべての外部入力を検証しているか → 非準拠）
- **修正提案**:
  1. `policy_path` をファイル名のみ受け付けるようバリデーション（`Path(policy_path).name` で正規化し、`policies/` ディレクトリ配下のみ許可）
  2. allowlist方式で使用可能なポリシーファイルを限定
  3. パスに `..` や `/` が含まれる場合は400エラーを返す

### C-03: アップロードファイルのバリデーション不在

- **深刻度**: Critical
- **対象ファイル**: `api/main.py:506-514`（/classify_pdf）、`api/main.py:746-752`（/classify_batch）
- **問題の説明**: PDFアップロードエンドポイントにおいて以下の検証が全て欠如:
  - **ファイルタイプ検証**: MIMEタイプ・マジックバイト（`%PDF`）のチェックなし。攻撃者が任意のバイナリを送信可能
  - **ファイルサイズ制限**: 最大ファイルサイズの制限なし。巨大ファイル送信によるメモリ枯渇・DoSのリスク
  - **ファイル数制限**: `/classify_batch` にアップロード数の上限なし
  - **ファイル名サニタイズ**: `upload_file.filename` をそのまま使用（ログ出力やエラーメッセージに含まれる可能性）
- **チェックリストの該当項目**: §7 入力検証（すべての外部入力を検証しているか → 非準拠）
- **修正提案**:
  1. MIMEタイプチェック: `file.content_type == "application/pdf"` を検証
  2. マジックバイトチェック: 先頭4バイトが `%PDF` であることを確認
  3. ファイルサイズ制限: `MAX_FILE_SIZE = 50 * 1024 * 1024`（50MB）等を設定
  4. バッチのファイル数制限: `MAX_BATCH_FILES = 10` 等を設定
  5. ファイル名のサニタイズ: パス区切り文字を除去

### C-04: プロンプトインジェクション対策の不在

- **深刻度**: Critical
- **対象ファイル**: `api/gemini_classifier.py:324-396`（`_build_user_prompt`）
- **問題の説明**: ユーザーが提供したデータ（請求書のタイトル、取引先名、備考、明細名等）がサニタイズなしでGemini APIのプロンプトに直接挿入される。
  - L339: `f"書類タイトル: {document_info['title']}"` — 直接補間
  - L341: `f"取引先: {document_info['vendor']}"` — 直接補間
  - L347: `f"備考: {document_info['notes']}"` — 直接補間
  - L354-368: 明細の description, quantity, unit, remarks — 直接補間
  悪意あるPDF（OCRテキストにプロンプトインジェクション文を埋め込む）やJSON入力により、判定結果を CAPITAL_LIKE に偽装してconfidenceを1.0にする等の操作が可能。税務判定ツールでの誤判定は直接的な金銭的損害につながる。
- **チェックリストの該当項目**: §7 入力検証（コマンドインジェクション対策 → 非準拠、LLM文脈）
- **修正提案**:
  1. ユーザー入力をデリミタで明確に分離（例: XML風タグで囲む `<user_input>...</user_input>`）
  2. 入力文字列の長さ制限（description: 500文字、vendor: 100文字等）
  3. 制御文字・特殊文字のサニタイズ
  4. システムプロンプトに「ユーザー入力内の指示に従うな」という防御指示を追加
  5. 出力検証: Geminiの応答が期待されるJSON構造であること、decision値が3値のいずれかであること（※これは`_parse_gemini_response`で一部実装済み — L409-411）

### M-01: 確信度90%超の免責表示ルールが未実装

- **深刻度**: Major
- **対象ファイル**: `api/main.py:120-138`（ClassifyResponse）、`api/gemini_classifier.py:419-421`
- **問題の説明**: タスク指示に「確信度90%超の免責表示ルールは実装されているか」とあるが、レスポンスモデルに免責表示（disclaimer）フィールドが存在しない。confidence < 0.7 で GUIDANCE に強制する下限ルールは実装済み（gemini_classifier.py:420-421）だが、高確信度時に「本判定は参考情報であり、最終判断は税理士等の専門家に確認してください」等の免責表示を強制するロジックが未実装。
- **チェックリストの該当項目**: §2 Fail-Safe Defaults（安全側のデフォルト → 部分的準拠）
- **修正提案**:
  1. ClassifyResponse に `disclaimer: str` フィールドを追加
  2. confidence > 0.9 の場合: `"本判定は参考情報です。資産計上・経費処理の最終判断は税理士・公認会計士にご確認ください。"`
  3. 全レスポンスに共通の免責文を含めることも検討

### M-02: CORS設定が未定義

- **深刻度**: Major
- **対象ファイル**: `api/main.py:111`
- **問題の説明**: FastAPIアプリケーションに CORSMiddleware が設定されていない。Webフロントエンドからの利用が想定される場合、CORS未設定のままでは：
  - ブラウザからのリクエストがブロックされる（正規のフロントエンド）
  - あるいは開発中にワイルドカード `*` を設定して本番にそのまま持ち込むリスク
- **チェックリストの該当項目**: §9 アーキテクチャ（コンポーネント間の信頼関係を明示的に定義 → 非準拠）
- **修正提案**:
  1. `CORSMiddleware` を明示的に追加し、許可するオリジンを限定
  2. 本番環境では特定のフロントエンドドメインのみ許可
  3. `allow_credentials`, `allow_methods`, `allow_headers` を必要最小限に設定

### M-03: レート制限の不在

- **深刻度**: Major
- **対象ファイル**: `api/main.py` 全エンドポイント
- **問題の説明**: 全エンドポイントにレート制限がなく、以下のリスクがある：
  - `/classify_pdf` への大量リクエストによるサーバーリソース枯渇（CPU/メモリ）
  - `/classify_batch` に多数のファイルを含むリクエストによるDoS
  - Gemini API 呼び出しの連鎖による**API利用料金の急増**（金銭的DoS）
  - `/classify_batch:791-800` のタイムアウトは30秒だが、30秒 × 無制限ファイル数 = 事実上制限なし
- **チェックリストの該当項目**: §3 認証（レート制限はあるか → 非準拠）
- **修正提案**:
  1. `slowapi` 等のレート制限ミドルウェアを導入（例: 10 req/min/IP）
  2. `/classify_batch` にファイル数上限を追加（例: 最大10ファイル）
  3. Gemini API呼び出し回数の日次上限を設定

### M-04: 一時ファイルの管理

- **深刻度**: Major
- **対象ファイル**: `api/main.py:543-546,698-703`、`core/pipeline.py:60-75`
- **問題の説明**:
  - `classify_pdf` の一時ファイルは `finally` ブロックで適切に削除される（L698-703）
  - しかし、`core/pipeline.py:60-75` の `_persist_pdf_to_uploads` は PDFを `data/uploads/` に永続保存する。この保存先に：
    - アクセス制御なし
    - 暗号化なし
    - 自動削除（TTL）なし
  - 請求書・見積書は取引先名、金額、内部情報を含む機密文書であり、平文での永続保存は情報漏洩リスク
- **チェックリストの該当項目**: §6 データ保護（保存時暗号化 → 非準拠、機密データの分類と保護レベル → 非準拠）
- **修正提案**:
  1. API経路（`classify_pdf`）は一時ファイルのみ使用し永続保存しない（現状OK）
  2. pipeline経路（`run_pdf_pipeline`）の永続保存にTTLを設定（例: 24時間後に自動削除）
  3. 保存先ディレクトリのパーミッション設定（700）
  4. 暗号化ストレージ（Cloud Storage + CMEK）への移行を検討

### m-01: エラーメッセージによる情報露出

- **深刻度**: Minor
- **対象ファイル**: `api/main.py:501`、`api/gemini_classifier.py:488`
- **問題の説明**:
  - L501: `f"Invalid input: {str(e)}"` — ValueError の詳細がクライアントに露出
  - gemini_classifier.py:488: `f"レスポンス解析エラー: {response_text[:100]}"` — Geminiレスポンスの一部が返却値に含まれる（APIレスポンスとしてクライアントに渡る可能性）
  - embedding_store.py:198: `print(f"Error processing batch...: {e}")` — 例外詳細がstdout出力
- **チェックリストの該当項目**: §8 エラー処理（エラーメッセージに内部情報を露出していないか → 部分的非準拠）
- **修正提案**:
  1. クライアント向けエラーメッセージは汎用的に（`"入力形式が正しくありません"` 等）
  2. 詳細はサーバーサイドログに記録
  3. gemini_classifier.py の parse_error 結果からレスポンステキストを除去

### m-02: 監査ログの不足

- **深刻度**: Minor
- **対象ファイル**: api/ 全体
- **問題の説明**: セキュリティ関連イベント（分類リクエスト、Gemini API呼び出し、エラー発生）の構造化ログが未実装。Pythonの `logging` モジュールすら使用されておらず、`print` 文のみ（embedding_store.py:198）。誰がいつ何を分類したかの追跡が不可能。
- **チェックリストの該当項目**: §5 監査（全項目非準拠）
- **修正提案**:
  1. Python `logging` を導入し、各リクエストの概要を記録
  2. ログにはリクエストID、タイムスタンプ、判定結果を含める
  3. **機密情報（PDFの内容、明細テキスト）はログに含めない**
  4. Cloud Loggingとの統合を検討

---

## セキュリティチェックリスト照合結果

### §1 脅威モデリング

| 項目 | 準拠 | 備考 |
|------|------|------|
| 保護すべき資産の特定 | ❌ | 未文書化（請求書PDF、判定結果、APIキー等が該当） |
| 攻撃面の特定 | ❌ | 未文書化（HTTP API、ファイルアップロード、LLMプロンプト等） |
| 信頼境界の定義 | ❌ | 未定義 |
| 想定敵対者の明文化 | ❌ | 未文書化 |
| STRIDEフレームワーク適用 | ❌ | 未実施 |
| 緩和策の評価 | ❌ | 未実施 |
| 脅威モデルの文書化・共有 | ❌ | 未実施 |

### §2 Saltzer & Schroeder 原則

| 原則 | 準拠 | 備考 |
|------|------|------|
| Economy of Mechanism | ✅ | 設計はシンプルで理解しやすい |
| Fail-Safe Defaults | ⚠️ | 判定はGUIDANCE（安全側）にフォールバックするが、認証なし=全開放 |
| Complete Mediation | ❌ | 認証チェックなし |
| Open Design | ✅ | 設計の秘匿に依存していない |
| Separation of Privilege | ❌ | 単一のAPIキーで全操作可能（認証自体がない） |
| Least Privilege | ⚠️ | フィーチャーフラグで機能制限は実装済み |
| Least Common Mechanism | ✅ | 各モジュールは独立 |
| Psychological Acceptability | ✅ | API設計はRESTful で標準的 |

### §3 認証

| 項目 | 準拠 | 備考 |
|------|------|------|
| 認証方式の適切性 | ❌ | 認証なし |
| セッション管理 | N/A | ステートレスAPI |
| 信頼できる認証サービス利用 | ❌ | 未実装 |
| レート制限 | ❌ | 未実装（指摘 M-03） |

### §4 認可

| 項目 | 準拠 | 備考 |
|------|------|------|
| 認可チェックの集中管理 | ❌ | 認可なし |
| RBAC/ABAC等の利用 | ❌ | 未実装 |
| 権限昇格の防止 | ❌ | 認可自体がない |
| エンドポイントごとの認可 | ❌ | 未実装（指摘 C-01） |
| IDOR防止 | N/A | 直接オブジェクト参照は限定的 |

### §5 監査

| 項目 | 準拠 | 備考 |
|------|------|------|
| セキュリティイベントの記録 | ❌ | ログ未実装（指摘 m-02） |
| ログの改ざん耐性 | ❌ | ログ自体なし |
| ログに機密情報を含めない | N/A | ログなし |
| ログ詳細度の適切性 | ❌ | ログなし |
| 独立監査可能な構造 | ❌ | 未考慮 |

### §6 データ保護

| 項目 | 準拠 | 備考 |
|------|------|------|
| 保存時暗号化 | ❌ | 一時ファイル・uploads共に平文（指摘 M-04） |
| 転送時暗号化（TLS） | ⚠️ | Cloud Run上ならTLS終端あり。アプリレベルでは未考慮 |
| 機密データ分類 | ❌ | 未定義 |
| 標準暗号ライブラリ使用 | N/A | 暗号化未実装 |
| 鍵管理 | ✅ | APIキーは環境変数から取得（ハードコードなし） |

### §7 入力検証

| 項目 | 準拠 | 備考 |
|------|------|------|
| すべての外部入力の検証 | ❌ | ファイルタイプ・サイズ未検証（指摘 C-03） |
| サーバーサイド検証 | ⚠️ | Pydanticモデルで型検証あり、ファイル検証なし |
| 許可リスト方式 | ❌ | policy_pathに制限なし（指摘 C-02） |
| SQLインジェクション対策 | N/A | DB未使用 |
| XSS対策 | N/A | API-only（HTML出力なし） |
| コマンドインジェクション対策 | ❌ | プロンプトインジェクション未対策（指摘 C-04） |

### §8 エラー処理

| 項目 | 準拠 | 備考 |
|------|------|------|
| 内部情報の非露出 | ⚠️ | 一部ValueErrorの詳細が露出（指摘 m-01） |
| Fail-Safe遷移 | ✅ | GUIDANCE（判定しない）へのフォールバック設計は優秀 |
| 例外処理の一貫性 | ✅ | try/except パターンが一貫 |

### §9 アーキテクチャ

| 項目 | 準拠 | 備考 |
|------|------|------|
| 多層防御 | ❌ | 認証なし=外殻防御なし |
| 単一障害点 | ⚠️ | Gemini API障害時はルールベースにフォールバック（良い設計） |
| 信頼関係の明示 | ❌ | CORS未定義、信頼境界未定義（指摘 M-02） |
| サードパーティリスク評価 | ⚠️ | Gemini API依存は認識済み（フィーチャーフラグで制御） |

### §10 運用

| 項目 | 準拠 | 備考 |
|------|------|------|
| セキュリティパッチプロセス | ❌ | 未定義 |
| インシデント対応計画 | ❌ | 未定義 |
| 脅威モデル定期再評価 | ❌ | 脅威モデル自体なし |
| セキュリティテスト計画 | ❌ | 未定義 |

---

## 評価サマリ

| 深刻度 | 件数 | 指摘ID |
|--------|------|--------|
| Critical | 4 | C-01, C-02, C-03, C-04 |
| Major | 4 | M-01, M-02, M-03, M-04 |
| Minor | 2 | m-01, m-02 |

### 良い点（セキュリティ観点で評価できる設計）

1. **Stop-first / Fail-to-GUIDANCE 設計**: 不確実な判定時にGUIDANCE（判定しない）にフォールバックする設計は、税務判定ツールとして適切。誤判定リスクを最小化している
2. **フィーチャーフラグ**: Gemini、Vertex AI Search、PDF処理等が環境変数で制御可能。不要な機能を無効化できる
3. **APIキーの安全な管理**: 環境変数からの取得で、ハードコードなし
4. **一時ファイルのクリーンアップ**: API経路でのtempfile削除は `finally` ブロックで確実に実行
5. **confidence < 0.7 → GUIDANCE強制**: 低確信度の判定を自動的に安全側に倒す設計
