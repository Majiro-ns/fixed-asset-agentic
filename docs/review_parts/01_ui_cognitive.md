# UI/認知判断レビュー

**レビュー日**: 2026-02-10
**レビュー対象**: ui/app.py, ui/app_minimal.py, ui/styles.py, ui/batch_upload.py, ui/components/\*
**ペルソナ**: 高卒事務の経理担当者（専門用語が分からない人）

---

## サマリ

1. **app_minimal.py + コンポーネント群**（production版）は「止まる→聞く→変わる」のAgentic設計が認知設計の原則に沿って実装されており、特にguidance_panel.pyの2段階ウィザードは秀逸。初見3秒テストもクリアする。
2. **app.py**（classic版）は開発者向け技術用語（Opal/Adapter/Classifier/凍結スキーマ/揺れるJSON）がUIテキストに大量に露出しており、ペルソナ「高卒事務の経理担当者」に対してCriticalレベルの認知障壁を形成している。
3. **共通課題**として、unsafe_allow_htmlで生成されるカスタムHTML要素にaria-label/alt属性が皆無でアクセシビリティ不適合、diff_display.pyの英語ラベル「Before:/After:」、内部分類コード（GUIDANCE/CAPITAL_LIKE）のテーブルへの漏出がある。

---

## 指摘事項

### 【C-01】app.py: タイトル・ステップラベルに開発者用技術用語が露出

- **深刻度**: Critical
- **対象ファイル**: `ui/app.py` 21〜34行目
- **問題の説明**: APP_TITLE に「Opal抽出 × Agentic判定」、STEP1〜3 に「揺れるJSON」「凍結スキーマ v1.0」「3値・断定しない」等の開発者用語が直接表示される。ペルソナ（高卒事務の経理担当者）にとって意味不明であり、「このツールは自分向けではない」と感じて即離脱するリスクが高い。
- **チェックリストの該当項目**:
  - コピーライティングCL §6「平易な言語を使用しているか: 専門用語を避け、中学生でも理解できる表現」
  - コピーライティングCL §4「ベネフィットを機能より先に伝えているか」
  - IA CL §C「社内用語・造語ではなく、ユーザーが理解できる言葉を使っているか」
- **修正提案**:
  ```python
  APP_TITLE = "固定資産判定 AI"
  APP_SUB = "見積書をアップするだけ。資産か経費か、AIが判定します。"
  STEP1 = "Step1｜書類の読み取り"
  STEP2 = "Step2｜データの整理"
  STEP3 = "Step3｜判定結果"
  ```

---

### 【C-02】app.py: 結果テーブルのカラム名が内部コード

- **深刻度**: Critical
- **対象ファイル**: `ui/app.py` 100〜113行目（`_to_table_rows`関数）
- **問題の説明**: テーブル行のキーが `classification`, `rationale_ja`, `flags`, `evidence` 等の英語内部コードのまま表示される。ペルソナにとって "classification" も "flags" も理解不能。
- **チェックリストの該当項目**:
  - Excel業務UI CL §2「列ヘッダーの書き方: 同じ概念に同じ語」「略語は定義付きで」
  - コピーライティングCL §6「平易な言語を使用しているか」
  - IA CL §C「全てのラベルが明瞭で記述的か」
- **修正提案**:
  ```python
  rows.append({
      "優先度": "要確認" if ...,
      "行番号": it.get("line_no"),
      "品名・内容": desc,
      "金額": amount_display,
      "判定": label_ja,       # classification → 判定
      "分類": cls_display,
      "判定理由": rationale_ja,  # rationale_ja → 判定理由
      "確認ポイント": flags_str,  # flags → 確認ポイント
      "根拠箇所": evidence_short, # evidence → 根拠箇所
  })
  ```

---

### 【M-01】diff_display.py: 英語ラベル「Before:/After:」

- **深刻度**: Major
- **対象ファイル**: `ui/components/diff_display.py` 87〜92行目
- **問題の説明**: 判定変化表示で「Before:」「After:」という英語ラベルを使用。ペルソナにとって英語は認知障壁。日本語UIの中に突然英語が出現し、一貫性も損なう。
- **チェックリストの該当項目**:
  - コピーライティングCL §5「同じ概念に同じ言葉を使用しているか」「フォーマリティの一貫性」
  - コピーライティングCL §6「平易な言語を使用しているか」
  - IA CL §C「サイト/アプリ全体で用語が統一されているか」
- **修正提案**:
  ```python
  f'<span style="color:#6B7280;">変更前:</span> '
  f'<span style="color:#6B7280;">変更後:</span> '
  ```

---

### 【M-02】app.py Step1: 情報過多による認知負荷超過

- **深刻度**: Major
- **対象ファイル**: `ui/app.py` 244〜320行目（`_render_json_flow` Step0）
- **問題の説明**: Step1画面に VALUE_STATEMENT + VALUE_BULLETS(3項目) + 進め方expander(3ステップ) + サンプル選択カラム + JSON貼付カラム + ポリシー表示 + 判定ボタン + JSONプレビューexpander が同時に表示される。初見3秒テストに失敗する。1画面1メッセージの原則に違反。
- **チェックリストの該当項目**:
  - UI設計CL §6「1画面1メッセージ: 各画面が1つの主要メッセージ/タスクに集中しているか」
  - UI設計CL §4「外在的認知負荷の排除」「プログレッシブ・ディスクロージャー」
  - Excel業務UI CL §3「上→下の流れ: 2列レイアウトは視線が迷う」
- **修正提案**: VALUE_STATEMENT/VALUE_BULLETSは初回訪問時のみ表示し、入力は1カラムに統一。サンプル選択とJSON貼付はタブで切り替え。

---

### 【M-03】unsafe_allow_htmlコンポーネントにアクセシビリティ属性が皆無

- **深刻度**: Major
- **対象ファイル**: `ui/components/result_card.py` 181〜199行目、`ui/components/guidance_panel.py` 全体、`ui/components/diff_display.py` 81〜101行目
- **問題の説明**: 判定結果カード、GUIDANCEパネル、差分表示の全てがst.markdown + unsafe_allow_htmlで生成されており、role属性、aria-label、aria-live等のアクセシビリティ属性が一切設定されていない。スクリーンリーダーでは装飾的なdivの羅列としか認識されない。
- **チェックリストの該当項目**:
  - UI設計CL §3「色だけに依存しない: リンク、エラー、状態表示が色以外の手がかりでも識別可能か」
  - コピーライティングCL §6「スクリーンリーダー対応: aria-labelが適切に設定されているか」
  - UI設計CL §2「冗長コーディング: 色だけでなく、形状・テキスト・アイコンでも情報を伝えているか」
- **修正提案**: 主要なカードに `role="alert"` / `role="status"` / `aria-label` を追加。結果カードには `role="region" aria-label="判定結果"` 等を設定。

---

### 【M-04】GUIDANCE時の用語揺れ: 「要確認」「GUIDANCE」「確認が必要」の混在

- **深刻度**: Major
- **対象ファイル**: 複数ファイルにまたがる
  - `ui/app.py` 94行目: `prefix = "[要確認] "`
  - `ui/app.py` 374行目: `m1.metric("⚠️ 要確認", ...)`
  - `ui/app.py` 385行目: `st.info(STOP_NOTE)` → "判断停止（Stop設計）"
  - `ui/app.py` 395行目: `st.warning("要確認（GUIDANCE）は誤判定ではありません")`
  - `ui/components/guidance_panel.py` 428行目: "AIが判断を保留しました"
  - `ui/components/diff_display.py` 16行目: "要確認（自動判定不可）"
  - `ui/app_minimal.py` 389行目: "確認が必要です"
  - `ui/app_minimal.py` 733行目: "確認が必要です"
- **問題の説明**: 同じ概念（AIが判断を保留した状態）に対して少なくとも5種類の表現が混在。ペルソナは「要確認」と「確認が必要」と「GUIDANCE」と「判断を保留」が同じことかどうか判断できない。
- **チェックリストの該当項目**:
  - コピーライティングCL §5「同じ概念に同じ言葉を使用しているか」
  - IA CL §C「サイト/アプリ全体で用語が統一されているか」
- **修正提案**: 「確認が必要です」に統一。内部コード「GUIDANCE」はUIに露出させない。「Stop設計」「判断停止」は開発者向け説明であり、ペルソナ向けUIからは削除。

---

### 【M-05】batch_upload.py: 空状態のガイドテキストに英語「Browse files」

- **深刻度**: Major
- **対象ファイル**: `ui/batch_upload.py` 273行目
- **問題の説明**: ファイル未選択時の案内テキストに「または上の「Browse files」ボタンをクリック」と英語が混在。StreamlitのデフォルトUI文言への依存だが、ペルソナにとって「Browse files」は理解不能。
- **チェックリストの該当項目**:
  - コピーライティングCL §6「平易な言語を使用しているか: 専門用語を避け、中学生でも理解できる表現」
  - コピーライティングCL §5「フォーマリティの一貫性: 画面によってカジュアル/フォーマルが変わっていないか」
- **修正提案**: 「または上の「ファイルを選択」ボタンをクリック」に変更。Streamlit自体の英語ボタンはCSSオーバーライドまたはカスタムコンポーネントで対応。

---

### 【M-06】app.py: STOP_NOTEの「Stop設計」が開発者用語

- **深刻度**: Major
- **対象ファイル**: `ui/app.py` 36行目
- **問題の説明**: `STOP_NOTE = "要確認は精度不足ではなく、判断停止（Stop設計）です。"` — 「Stop設計」はシステム設計の概念であり、ペルソナにとって意味不明。精度不足/判断停止の区別を説明しようとしているが、ペルソナはそもそも精度不足を疑っていない可能性が高い。
- **チェックリストの該当項目**:
  - コピーライティングCL §4「ベネフィットを機能より先に伝えているか: 技術説明→ベネフィット翻訳」
  - コピーライティングCL §6「平易な言語を使用しているか」
- **修正提案**:
  ```python
  STOP_NOTE = "「確認が必要」は、AIが正確に判断できない部分です。あなたの確認で正しい処理ができます。"
  ```

---

### 【M-07】app.py: 結果サマリーのmetricラベルが内部視点

- **深刻度**: Major
- **対象ファイル**: `ui/app.py` 374〜376行目
- **問題の説明**: metricウィジェットのラベルが「⚠️ 要確認」「✅ 資産計上の可能性あり」「💰 経費処理の可能性あり」。「可能性あり」は曖昧であり、ペルソナは「で、結局どっちなの？」と思う。helpテキストは良いが、metricラベル自体の表現が内部分類カテゴリの直訳。
- **チェックリストの該当項目**:
  - コピーライティングCL §1「ボタンラベルは具体的なアクション名か」（ラベル全般）
  - コピーライティングCL §4「フレーミングは適切か」
- **修正提案**:
  ```python
  m1.metric("⚠️ あなたが確認する行", counts["GUIDANCE"])
  m2.metric("✅ 資産として計上", counts["CAPITAL_LIKE"])
  m3.metric("💰 経費としてOK", counts["EXPENSE_LIKE"])
  ```

---

### 【M-08】styles.py: 免責事項のコントラスト不足の懸念

- **深刻度**: Major
- **対象ファイル**: `ui/styles.py` 122〜126行目
- **問題の説明**: `.disclaimer` クラスの文字色が `#9CA3AF`（グレー）で、白背景に対するコントラスト比は約2.9:1。WCAG AAの通常テキスト基準4.5:1を大幅に下回る。免責事項は法的に重要な情報であり、読めない状態は問題。
- **チェックリストの該当項目**:
  - UI設計CL §3「通常テキストのコントラスト比: 4.5:1以上（WCAG AA）を確保しているか」
- **修正提案**: 文字色を `#6B7280` 以上の濃さに変更（コントラスト比4.6:1以上）。または背景をわずかに暗くする。

---

### 【m-01】hero_section.py: 「Powered by Gemini 3 Pro」がペルソナに不要

- **深刻度**: Minor
- **対象ファイル**: `ui/components/hero_section.py` 24行目、65行目
- **問題の説明**: 技術バッジ「Powered by Gemini 3 Pro」はペルソナにとって意味のない情報であり、認知負荷をわずかに増加させる。注意を引く要素は3つ以内の原則に照らすと、タイトル・ステップ・アップロードの3つだけで十分。
- **チェックリストの該当項目**:
  - UI設計CL §4「外在的認知負荷の排除: 装飾的・不必要な視覚要素を除去したか」
- **修正提案**: ペルソナ向けには非表示にするか、フッターの免責事項付近に移動。

---

### 【m-02】input_area.py: 「高精度モード（AI Vision）」のラベルが技術的

- **深刻度**: Minor
- **対象ファイル**: `ui/components/input_area.py` 350〜355行目
- **問題の説明**: トグルラベル「🎯 高精度モード（AI Vision）」の「AI Vision」はペルソナにとって不要な技術情報。helpテキスト「手書き・複雑な表に対応」は良いが、ラベル自体が不必要に技術的。
- **チェックリストの該当項目**:
  - コピーライティングCL §4「ベネフィットを機能より先に伝えているか」
- **修正提案**: 「🎯 高精度モード（手書き・複雑な表に対応）」

---

### 【m-03】app_minimal.py: 確信度の表現「たぶん大丈夫」のトーン問題

- **深刻度**: Minor
- **対象ファイル**: `ui/app_minimal.py` 398行目、`ui/components/result_card.py` 47行目
- **問題の説明**: confidence 0.6〜0.8の表現が「たぶん大丈夫」。会計処理の文脈で「たぶん」は不安を煽る可能性がある。ペルソナは数値（60%〜80%）は理解しにくいが、「たぶん」は軽すぎる。
- **チェックリストの該当項目**:
  - コピーライティングCL §5「トーンの一貫性」
- **修正提案**: 「概ね確実（念のため確認推奨）」

---

### 【m-04】guidance_panel.py: 「修繕・維持→経費になります」の断言リスク

- **深刻度**: Minor
- **対象ファイル**: `ui/components/guidance_panel.py` 466〜468行目
- **問題の説明**: 修繕ボタンの説明に「→ 経費になります」と断定表現がある。GUIDANCE状態（＝AIが判断できない状態）でユーザー選択前に結果を断言するのは矛盾。金額によっては修繕でも資本的支出になる場合がある。
- **チェックリストの該当項目**:
  - コピーライティングCL §4「フレーミングは適切か」
- **修正提案**: 「→ 経費になることが多いです」

---

### 【m-05】app.py: サイドバーのヘルプ項目にクリッカブルな要素がない

- **深刻度**: Minor
- **対象ファイル**: `ui/app.py` 642〜645行目
- **問題の説明**: サイドバーの「📖 ヘルプ」セクションのcaptionテキストは情報提供のみで、「要確認とは？」等をクリックして詳細を見る導線がない。ペルソナは初見時にヘルプを必要とする可能性が高いが、expanderもリンクもない。
- **チェックリストの該当項目**:
  - IA CL §D「同一コンテンツに複数のアクセス経路を用意しているか」
- **修正提案**: 各ヘルプ項目をexpanderまたはtooltipにし、詳細説明へのアクセスを提供。

---

## チェックリスト照合結果

### 1. UI設計_認知誘導チェックリスト

| セクション | 項目 | app_minimal.py (production) | app.py (classic) |
|-----------|------|---------------------------|-----------------|
| §1 視線誘導 | 視線パターンの選択 | ✅ 1カラムF型 | ⚠️ 2カラム混在 |
| §1 | 最重要情報の配置（左上） | ✅ ヒーロー→入力 | ⚠️ 左上にサンプル選択 |
| §1 | 見出し階層 | ✅ h1→caption | ⚠️ h2/h3混在 |
| §1 | グルーピング | ✅ コンポーネント分離 | ⚠️ 密集気味 |
| §1 | 視線終着点にCTA | ✅ 判定ボタンが適切 | ⚠️ 右下に配置だが分かりにくい |
| §2 色彩設計 | 色数の制限 | ✅ 4色体系（amber/green/blue/gray） | ✅ 同左 |
| §2 | 原色の戦略的使用 | ✅ 赤はエラーのみ | ✅ 同左 |
| §2 | ポップアウト効果 | ✅ GUIDANCEのamberが目立つ | ✅ 同左 |
| §2 | 色コードの一貫性 | ✅ 全コンポーネントで統一 | ✅ 同左 |
| §2 | 冗長コーディング | ✅ 色+emoji+テキスト | ✅ 色+emoji+テキスト |
| §3 コントラスト | 通常テキストのコントラスト比 | ❌ disclaimer#9CA3AF（約2.9:1） | ❌ 同左 |
| §3 | 色だけに依存しない | ✅ テキスト併用 | ✅ テキスト併用 |
| §4 認知負荷 | 外在的認知負荷の排除 | ✅ シンプル | ❌ 技術用語が多い |
| §4 | プログレッシブ・ディスクロージャー | ✅ expander活用 | ⚠️ Step1に情報過多 |
| §4 | 1画面1メッセージ | ✅ | ❌ Step1に複数メッセージ |
| §5 インタラクション | ボタンの視覚的優先度 | ✅ primary/default区別 | ✅ primary/default区別 |
| §5 | ローディング表示 | ✅ skeleton animation | ✅ st.progress |
| §5 | エラー表示 | ✅ st.error使用 | ✅ st.error使用 |

### 2. コピーライティング_認知誘導チェックリスト

| セクション | 項目 | production版 | classic版 |
|-----------|------|------------|----------|
| §1 マイクロコピー | ボタンラベルは具体的か | ✅「判定を実行」 | ✅「判定を実行して進む」 |
| §1 | 動詞始まりか | ✅ | ✅ |
| §2 エラーメッセージ | 認知→説明→指示 | ✅ | ✅ |
| §2 | ユーザーを責めていないか | ✅ | ✅ |
| §2 | 技術用語を使っていないか | ⚠️ 一部「API」露出 | ❌「JSONのパース」 |
| §3 フォーム | プレースホルダーで入力例 | N/A（PDF主体） | ✅ JSON例あり |
| §4 説得 | ベネフィットを機能より先に | ✅ ヒーロー文 | ❌ 技術機能が先 |
| §4 | confirmshaming | ✅ なし | ✅ なし |
| §5 トーン | 同じ概念に同じ言葉 | ❌ 要確認/確認が必要/GUIDANCE混在 | ❌ 同左+Stop設計 |
| §5 | フォーマリティの一貫性 | ⚠️「たぶん大丈夫」のみ軽い | ⚠️ 同左 |
| §6 アクセシビリティ | 平易な言語 | ✅ | ❌ 技術用語多数 |
| §6 | スクリーンリーダー対応 | ❌ aria-label皆無 | ❌ aria-label皆無 |

### 3. Excel業務UI_言語色配置ルール集

| セクション | 項目 | 結果 |
|-----------|------|------|
| §1 色ルール | セル背景色は薄く | ✅ パステル系使用 |
| §1 | 5色以内 | ✅ amber/green/blue/gray/white |
| §1 | 色だけで情報を伝えない | ✅ テキスト+emoji併用 |
| §2 言語ルール | 列ヘッダーは名詞形 | ❌ 英語コード名（classification等） |
| §2 | 単位を明示 | ✅ 「JPY」「¥」表記あり |
| §2 | ステータス表示の統一 | ❌ 複数表現が混在 |
| §3 配置ルール | 数値列は右揃え | ⚠️ st.dataframeのデフォルト依存 |
| §3 | アクション列は右端 | ✅ ボタンは適切な位置 |

### 4. 情報設計（IA）チェックリスト

| セクション | 項目 | production版 | classic版 |
|-----------|------|------------|----------|
| §A 準備 | ペルソナ定義 | ✅ guidance_panel冒頭 | ⚠️ 明記なし |
| §B 階層 | 深さ3層以内 | ✅ フラット構造 | ✅ 3ステップ構造 |
| §B | 選択肢の数 | ✅ 2択（修繕/新規購入） | ⚠️ 多い |
| §C ラベリング | 明瞭で記述的 | ⚠️ 一部英語混在 | ❌ 技術用語多数 |
| §C | 用語統一 | ❌ 要確認/GUIDANCE/確認が必要 | ❌ 同左+Stop設計 |
| §C | Information Scent | ✅ アイコン+ラベル | ⚠️ ステップ名が技術的 |
| §D ナビ | 現在地把握 | ✅ ステップインジケーター | ✅ radioボタン+progress |
| §E 連携 | コピーとIAの一致 | ✅ | ❌ 内部コードが混在 |
| §E | 色が構造シグナルとして一貫 | ✅ | ✅ |

---

## 「止まる→聞く→変わる」Agentic設計の評価

### 止まる（GUIDANCE判定）

| 観点 | production版 | classic版 |
|------|------------|----------|
| 「止まった」感の演出 | ✅ 🛑アイコン + amberカード + 「AIが判断を保留しました」 | ⚠️ metric数値のみ |
| 止まった理由の説明 | ✅ missing_fieldsを人間向けに翻訳 | ⚠️ flags生データ表示 |
| ユーザーへの安心感 | ✅ 「この書類は自動判定できません」 | ❌ 「判断停止（Stop設計）です」 |

### 聞く（ユーザーへの質問）

| 観点 | production版 | classic版 |
|------|------------|----------|
| 質問の明確さ | ✅ 2択（修繕 vs 新規購入）+ カード演出 | ⚠️ 2択ボタンのみ |
| 段階的質問 | ✅ Step1→Step2のウィザード | ❌ 1段階のみ |
| ヒントの提供 | ✅ gp-hint-box | ❌ なし |
| 類似事例の表示 | ✅ similar_case | ❌ なし |

### 変わる（判定変更の可視化）

| 観点 | production版 | classic版 |
|------|------------|----------|
| 変化の可視化 | ✅ diff_displayコンポーネント | ⚠️ テキストのみ |
| 変化理由の説明 | ✅ 理由のdiff表示 | ❌ なし |
| 監査証跡 | ✅ 「監査時の説明資料として利用」 | ❌ なし |

**総合評価**: production版のAgentic設計は認知設計の原則に適合。classic版（app.py）はAgentic設計の表現が開発者視点に偏っている。

---

## 初見3秒テスト

| 画面 | production版 | classic版 |
|------|------------|----------|
| トップ | ✅「固定資産判定 AI — 見積書をアップするだけ」→ 目的明確 | ❌「見積書 固定資産判定（Opal抽出 × Agentic判定）」→ 意味不明 |
| GUIDANCE | ✅「🛑 AIが判断を保留しました → 下のボタンで教えてください」→ 次のアクション明確 | ⚠️ metric + 説明テキスト混在 |
| 結果 | ✅ 大型カード + 金額 + 信頼度バー → 結果一目瞭然 | ⚠️ テーブル表示 → 読み取りに時間がかかる |

---

## 優先度別アクションリスト

### 即時対応（Critical）
1. **C-01**: app.pyの技術用語をユーザー向けに全面書き換え
2. **C-02**: テーブルカラム名を日本語に変更

### 次スプリント（Major）
3. **M-01**: diff_displayの英語ラベルを日本語化
4. **M-02**: app.py Step1の情報量を削減
5. **M-03**: カスタムHTMLにaria属性を追加
6. **M-04**: GUIDANCE関連の用語を統一
7. **M-05**: batch_uploadの英語テキストを日本語化
8. **M-06**: STOP_NOTEの文言をユーザー向けに修正
9. **M-07**: metricラベルをユーザー視点の表現に変更
10. **M-08**: disclaimerのコントラスト比を改善

### 改善（Minor）
11. **m-01**: Geminiバッジの配置を再検討
12. **m-02**: 高精度モードのラベル改善
13. **m-03**: 確信度の中間表現を調整
14. **m-04**: GUIDANCE選択肢の断言表現を緩和
15. **m-05**: サイドバーヘルプにexpanderを追加
